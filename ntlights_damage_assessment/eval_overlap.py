# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/04_eval_overlap.ipynb.

# %% auto 0
__all__ = ['compute_overlaps']

# %% ../nbs/04_eval_overlap.ipynb 4
import requests
import json
from fastcore.all import L
import pandas as pd
from typing import Any
from urllib.parse import urlparse
from pathlib import Path
import numpy as np
import re
from shapely.geometry import Polygon, box
from shapely import wkt
import geopandas as gpd
import sqlite3 as sql3
from pandas.io import sql 
import sqlalchemy as sqalc
import geowrangler.area_zonal_stats as azs

# %% ../nbs/04_eval_overlap.ipynb 5
from ntlights_damage_assessment.fetch_coords import search_dates_aoi 

# %% ../nbs/04_eval_overlap.ipynb 14
def compute_overlaps(aoi, matched_results):
    aoi_planar = aoi.to_crs('EPSG:3857')
    aoi_planar['bound_area'] = aoi_planar.geometry.area
    matched_planar = matched_results.to_crs('EPSG:3857')
    matched_planar['section_area'] = matched_planar.geometry.area
    results = azs.create_area_zonal_stats(matched_planar, aoi_planar, aggregations=[])
    tot_aoi_area = aoi_planar.bound_area.sum()
    results['pct_covered'] = results['intersect_area_sum'] / tot_aoi_area 
    sorted_results = results.sort_values(by='pct_covered',ascending=False)
    return sorted_results
